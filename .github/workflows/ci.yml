name: smoke

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      tag:
        description: "Cucumber tag (@smoke / @regression)"
        required: true
        default: "@smoke"

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      selenium:
        image: selenium/standalone-chrome:latest
        ports:
          - 4444:4444
        options: >-
          --shm-size=2g

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"
          cache: maven

      - name: Wait for Selenium
        run: |
          for i in {1..60}; do
            if curl -fsS http://localhost:4444/status | grep -q '"ready"[[:space:]]*:[[:space:]]*true'; then
              echo "Selenium is ready"
              break
            fi
            echo "Still waiting ($i)..."
            sleep 2
          done

      - name: Run Cucumber tests (QUALITY GATE)
        working-directory: ui
        env:
          SELENIUM_REMOTE_URL: "http://localhost:4444/wd/hub"
          HEADLESS: "true"
        run: |
          TAG="${{ github.event.inputs.tag }}"
          if [ -z "$TAG" ]; then TAG="@smoke"; fi
          mvn -f pom.xml clean test -Dcucumber.filter.tags="$TAG"
