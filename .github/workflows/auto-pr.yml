name: Auto PR (create + label automerge)

on:
  push:
    branches:
      - "feature/**"
      - "hotfix/**"

permissions:
  contents: read
  pull-requests: write

jobs:
  create_pr:
    runs-on: ubuntu-latest
    steps:
      - name: Create PR to main (if not exists) + add label automerge
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const branch = context.ref.replace('refs/heads/', '');
            const head = `${owner}:${branch}`;
            const base = 'main';

            const prs = await github.rest.pulls.list({
              owner, repo, state: 'open', head, base, per_page: 10
            });

            let pr;
            if (prs.data.length > 0) {
              pr = prs.data[0];
              core.info(`PR already exists: #${pr.number}`);
            } else {
              const created = await github.rest.pulls.create({
                owner, repo,
                title: `Auto PR: ${branch} → ${base}`,
                head,
                base,
                body: "PR créée automatiquement. Auto-merge après checks ✅ (squash)."
              });
              pr = created.data;
              core.info(`Created PR: #${pr.number}`);
            }

            const labelName = "automerge";
            try {
              await github.rest.issues.getLabel({ owner, repo, name: labelName });
            } catch {
              await github.rest.issues.createLabel({
                owner, repo, name: labelName, color: "3affaa", description: "Auto-merge when checks pass"
              });
            }

            await github.rest.issues.addLabels({
              owner, repo, issue_number: pr.number, labels: [labelName]
            });