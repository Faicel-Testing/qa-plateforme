stages:
  - test
  - notify

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
  SELENIUM_REMOTE_URL: "http://selenium:4444/wd/hub"
  HEADLESS: "true"
  MAIL_TO: "ghanmif153@gmail.com"

cache:
  paths:
    - .m2/repository

test_job:
  stage: test
  allow_failure: true
  image: maven:3.9-eclipse-temurin-17

  services:
    - name: selenium/standalone-chrome:latest
      alias: selenium

  before_script:
    - apt-get update && apt-get install -y curl wget unzip
    - echo "Waiting for Selenium Grid..."
    - |
      for i in $(seq 1 60); do
        if curl -fsS http://selenium:4444/status | grep -q '"ready"[[:space:]]*:[[:space:]]*true'; then
          echo "Selenium is ready"
          break
        fi
        echo "Still waiting ($i)..."
        sleep 2
      done

  script:
    - mvn --version
    - mvn -e clean test -Dheadless=${HEADLESS} || true

    # Allure CLI
    - wget -q https://github.com/allure-framework/allure2/releases/latest/download/allure-2.27.0.zip -O /tmp/allure.zip
    - unzip -q /tmp/allure.zip -d /opt/

    # Generate Allure HTML report if results exist
    - |
      if [ -d "target/allure-results" ] && [ "$(ls -A target/allure-results 2>/dev/null)" ]; then
        /opt/allure-2.27.0/bin/allure generate target/allure-results -o target/allure-report --clean || true
      else
        echo "No allure-results directory found or empty"
      fi

    # Share test job id with next stage
    - echo "TEST_JOB_ID=$CI_JOB_ID" > build.env

  artifacts:
    when: always
    expire_in: 7 days
    paths:
      - target/surefire-reports/
      - target/cucumber-reports/
      - target/allure-results/
      - target/allure-report/
    reports:
      dotenv: build.env

notify_email:
  stage: notify
  image: python:3.11-alpine
  needs:
    - job: test_job
      artifacts: true
  when: always
  before_script:
    - apk add --no-cache ca-certificates
  script:
    - python -V
    - |
      python - <<'PY'
      import os, smtplib
      from email.mime.text import MIMEText

      to_addr = os.getenv("MAIL_TO")
      smtp_user = os.getenv("SMTP_USER")
      smtp_pass = os.getenv("SMTP_PASS")

      project_url = os.getenv("CI_PROJECT_URL", "")
      pipeline_id = os.getenv("CI_PIPELINE_ID", "")
      pipeline_url = f"{project_url}/-/pipelines/{pipeline_id}" if project_url and pipeline_id else ""

      test_job_id = os.getenv("TEST_JOB_ID", "")
      status = os.getenv("CI_PIPELINE_STATUS", "unknown")
      branch = os.getenv("CI_COMMIT_REF_NAME", "")
      sha = os.getenv("CI_COMMIT_SHORT_SHA", "")

      allure_link = ""
      if project_url and test_job_id:
        allure_link = f"{project_url}/-/jobs/{test_job_id}/artifacts/file/target/allure-report/index.html"

      body = f"""Pipeline status: {status}
Project: {os.getenv('CI_PROJECT_PATH', '')}
Branch: {branch}
Commit: {sha}

Pipeline: {pipeline_url}
Allure report: {allure_link if allure_link else 'N/A'}
  """

      if not (smtp_user and smtp_pass and to_addr):
        raise SystemExit("Missing SMTP_USER/SMTP_PASS/MAIL_TO variables")
  
  msg = MIMEText(body, "plain", "utf-8")
  msg["Subject"] = f"[GitLab CI] {status} - {os.getenv('CI_PROJECT_PATH','')} ({branch})"
  msg["From"] = smtp_user
  msg["To"] = to_addr

with smtplib.SMTP("smtp.gmail.com", 587) as s:
  s.ehlo()
  s.starttls()
  s.login(smtp_user, smtp_pass)
  s.send_message(msg)
  
  print("Email sent to:", to_addr)
  PY
